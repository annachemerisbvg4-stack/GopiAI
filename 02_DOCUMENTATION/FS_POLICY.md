# Политика работы с файловой системой (FS Policy) для GopiAI

Цели:
- Снизить риск PermissionError/ENOENT/EROFS/ENOTDIR при работе в разных средах (Windows/macOS/Linux, контейнеры).
- Централизовать места записи служебных файлов (логи и состояние).
- Обеспечить воспроизводимую диагностику.

## 1) Каталоги и файлы по умолчанию

- Логи CrewAI backend:
  - Путь: $HOME/.gopiai/logs/crewai_api_server_debug.log
  - Гарантируется создание каталога: parents=True, exist_ok=True
  - Ротация: RotatingFileHandler, maxBytes=10MB, backupCount=5
  - Фолбэк: при ошибке создания каталога — текущий каталог процесса

- Файл состояния:
  - Путь: $HOME/.gopiai/state.json
  - При старом расположении (~/.gopiai_state.json) — автоматическая миграция
  - Каталог $HOME/.gopiai создаётся автоматически

Примечания:
- Домашний каталог определяется через Path.home(); не используйте строку "~" напрямую.
- Все относительные пути внутри приложения либо преобразуются в абсолютные, либо проверяются на возможность записи.

## 2) Переменные окружения

- GOPIAI_LOG_DIR (опционально):
  - Если необходимо переопределить путь логов, укажите абсолютный путь и обеспечьте права на запись пользователю процесса.
  - По умолчанию используется $HOME/.gopiai/logs.

- PROVIDER API-ключи:
  - OPENROUTER_API_KEY, GEMINI_API_KEY и т.п.
  - Не влияют на FS напрямую, но определяют сценарии инициализации.

## 3) Рекомендации по контейнерам

- Смонтируйте HOME и каталог логов на хост:
  - -v $(pwd)/host_gopiai_home:/home/appuser:rw
  - -v $(pwd)/host_logs:/app/run_logs:rw и установите GOPIAI_LOG_DIR=/app/run_logs
- Убедитесь, что USER в контейнере имеет права записи (uid/gid).
- При SELinux используйте :z или :Z и/или chcon.

## 4) Диагностика доступа к FS

Минимальный зонд:
- diagnostics/file_access_probe.py
- Запуск: python diagnostics/file_access_probe.py > probe_stdout.log 2>&1
- Проверяет:
  - Запись лога в CWD
  - Создание CWD/logs_dir + запись
  - Запись $HOME/.gopiai/state.json
  - Списки каталогов для быстрой визуальной проверки

Ожидаемые типы ошибок и их причины:
- PermissionError: нет прав записи в целевой каталог
- FileNotFoundError/NotADirectoryError: путь некорректен или родительский каталог не существует
- OSError: Read-only file system: монтирование :ro или неизменяемая файловая система

## 5) Практики для разработчиков

- Никогда не рассчитывайте на доступность текущего рабочего каталога для записи; используйте $HOME/.gopiai для служебных файлов.
- Перед записью файлов обязательно создавайте родительские каталоги.
- Для пользовательских путей:
  - Нормализуйте: Path(BASE) / относительный_путь -> resolve()
  - Ограничивайте рабочее пространство (whitelist) и запрещайте directory traversal.
- При изменении местоположений служебных файлов — документируйте и добавляйте миграцию.

Версия документа: 1.0 (2025-08-07)
