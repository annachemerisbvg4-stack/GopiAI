# Исправления проблемы таймаутов CrewAI API

## Проблема
Частые ошибки "HTTPConnectionPool(host='127.0.0.1', port=5050): Read timed out. (read timeout=15)" при использовании CrewAI API.

## Причина
Слишком короткие таймауты (15 секунд) для операций CrewAI, которые могут занимать значительно больше времени.

## Внесенные исправления

### 1. GopiAI-UI/gopiai/ui/components/crewai_client.py
- Увеличен `self.timeout` с 5 до 30 секунд
- Увеличен таймаут для `/api/analyze` с 15 до 30 секунд  
- Увеличен таймаут для `/api/process` с 15 до 120 секунд
- Увеличен таймаут для `/api/index_docs` с 15 до 60 секунд

### 2. GopiAI-Core/gopiai/core/crewai_client.py
- Увеличен таймаут POST запросов с 15 до 120 секунд
- Увеличен таймаут GET запросов с 15 до 30 секунд

### 3. GopiAI-CrewAI/crewai_api_server.py
- Добавлены глобальные настройки таймаутов:
  - `REQUEST_TIMEOUT = 300` секунд (5 минут)
  - `CONNECTION_TIMEOUT = 60` секунд (1 минута)
- Настроен Werkzeug WSGI Request Handler с увеличенными таймаутами
- Включен многопоточный режим сервера (`threaded=True`)

### 4. 05_TESTS/test_rag_crewai_matrix.py
- Увеличен `TEST_TIMEOUT` с 20 до 150 секунд
- Увеличен таймаут `_send_test_request` с 15 до 120 секунд
- Исправлен fallback таймаут с 15 до 120 секунд

## Новые значения таймаутов

| Компонент | Старое значение | Новое значение | Назначение |
|-----------|----------------|----------------|------------|
| Клиент базовый таймаут | 5 сек | 30 сек | Быстрые операции |
| Анализ запроса | 15 сек | 30 сек | Анализ сложности |
| Обработка запроса | 15 сек | 120 сек | CrewAI операции |
| Индексация документов | 15 сек | 60 сек | RAG индексация |
| Сервер таймаут | не настроен | 300 сек | Серверные операции |
| Тестирование | 20 сек | 150 сек | Тестовые сценарии |

## Ожидаемые результаты
- Значительное снижение ошибок таймаута при работе с CrewAI
- Возможность обработки сложных запросов без прерывания
- Более стабильная работа системы при высокой нагрузке
- Успешное выполнение длительных операций CrewAI (анализ, генерация контента, исследования)

## Рекомендации
1. Мониторить время выполнения запросов в логах
2. При необходимости дополнительно увеличить таймауты для особо сложных задач
3. Рассмотреть возможность добавления прогресс-индикаторов для длительных операций
4. Настроить автоматический перезапуск серверов при критических ошибках

## Тестирование
Рекомендуется протестировать систему с:
- Простыми запросами (ожидаемое время: < 30 сек)
- Средними запросами (ожидаемое время: 30-120 сек)  
- Сложными запросами (ожидаемое время: 120-300 сек)

Дата исправления: 30.06.2025
