# Исправление проблемы с кратковременной памятью ИИ

## Проблема
В текущей реализации клиента CrewAI история сообщений не передается в запросы к API CrewAI, что приводит к отсутствию кратковременной памяти у ИИ.

## Решение
Необходимо модифицировать метод `process_request` в файле `GopiAI-UI\gopiai\ui\components\crewai_client.py`, чтобы добавить историю сообщений из менеджера памяти в запросы к API.

## Изменения

В файле `GopiAI-UI\gopiai\ui\components\crewai_client.py` найдите метод `process_request` и добавьте следующий код перед строкой `logger.debug(f"[REQUEST] Подготовка к отправке запроса в CrewAI API")`:

```python
# Получаем историю сообщений для текущей сессии
try:
    # Импортируем менеджер памяти
    from ..memory import get_memory_manager
    memory_manager = get_memory_manager()
    
    # Получаем ID сессии из метаданных сообщения
    session_id = message.get('metadata', {}).get('session_id', 'default_session')
    logger.debug(f"[REQUEST] Получение истории сообщений для сессии: {session_id}")
    
    # Получаем историю сообщений (последние 20 сообщений)
    chat_history = memory_manager.get_chat_history(session_id)
    if chat_history:
        # Берем последние 20 сообщений
        chat_history = chat_history[-20:]
        logger.info(f"[REQUEST] Получено {len(chat_history)} сообщений из истории для сессии {session_id}")
        
        # Добавляем историю сообщений в метаданные запроса
        message['metadata']['chat_history'] = chat_history
        logger.debug(f"[REQUEST] История сообщений добавлена в запрос")
    else:
        logger.debug(f"[REQUEST] История сообщений для сессии {session_id} не найдена")
except Exception as e:
    logger.error(f"[REQUEST-ERROR] Ошибка при получении истории сообщений: {e}")
```

## Объяснение изменений

1. Импортируем менеджер памяти из модуля `memory`
2. Получаем ID текущей сессии из метаданных сообщения (или используем 'default_session', если ID не указан)
3. Получаем историю сообщений для текущей сессии с помощью метода `get_chat_history`
4. Ограничиваем историю последними 20 сообщениями для оптимизации размера запроса
5. Добавляем историю сообщений в метаданные запроса, которые будут переданы в API CrewAI
6. Обрабатываем возможные ошибки и логируем их

## Проверка работоспособности

После внесения изменений можно проверить работоспособность следующим образом:

1. Перезапустите приложение
2. Начните новый диалог с ИИ
3. Задайте вопрос, требующий контекста из предыдущих сообщений
4. Убедитесь, что ИИ корректно использует контекст из предыдущих сообщений

## Дополнительные рекомендации

Также рекомендуется проверить, что на стороне сервера CrewAI API (в файле `GopiAI-CrewAI\tools\gopiai_integration\smart_delegator.py`) корректно обрабатывается история сообщений из метаданных запроса. В методе `_format_prompt` должен быть код, который извлекает историю сообщений из метаданных и добавляет ее в промпт для LLM.