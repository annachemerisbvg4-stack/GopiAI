# Улучшенная система переключения провайдеров LLM

## Обзор

Этот документ описывает улучшения в системе переключения провайдеров LLM (Large Language Models) для обеспечения стабильной работы приложения GopiAI. Основные проблемы, которые были решены:

1. **Синхронизация UI ⇆ Backend** - обеспечение согласованности состояния между интерфейсом и сервером
2. **Устойчивый UsageTracker** - корректное отслеживание лимитов и реализация мягкого черного списка
3. **Надежный цикл API-ключей** - предотвращение дубликатов и валидация ключей
4. **Автотесты** - автоматизированное тестирование для предотвращения регрессий

## Архитектура

### Основные компоненты

1. **`llm_rotation_config_fixed.py`** - улучшенная версия backend конфигурации
2. **`model_selector_widget.py`** - улучшенный frontend виджет с интеграцией REST API
3. **`state_manager.py`** - управление состоянием в файле `~/.gopiai_state.json`
4. **`crewai_api_server.py`** - REST API эндпоинты для синхронизации

### Поток данных

```
UI (model_selector_widget.py)
├── Сохраняет API ключи в .env
├── Отправляет изменения состояния в /internal/state (POST)
├── Получает список моделей от /internal/models (GET)
└── Загружает начальное состояние из /internal/state (GET)

Backend (llm_rotation_config_fixed.py)
├── Читает API ключи из переменных окружения
├── Сохраняет состояние в ~/.gopiai_state.json
├── Отслеживает использование моделей (UsageTracker)
└── Реализует мягкий черный список для превышений лимитов

State Manager (state_manager.py)
└── Управляет файлом ~/.gopiai_state.json
```

## Улучшения

### 1. Синхронизация UI ⇆ Backend

#### Backend
- Добавлены REST API эндпоинты:
  - `GET /internal/models?provider={provider_name}` - список доступных моделей
  - `POST /internal/state` - обновление состояния провайдера/модели
  - `GET /internal/state` - получение текущего состояния

#### Frontend
- Интеграция с REST API для синхронизации состояния
- Автоматическая загрузка начального состояния при запуске
- Уведомление backend при изменении провайдера/модели
- Улучшенное обновление списка моделей

### 2. Устойчивый UsageTracker

#### Улучшения:
- **Правильное переключение провайдеров**: метод `set_current_provider()` корректно сбрасывает лимиты для других провайдеров
- **Мягкий черный список**: автоматическая блокировка моделей при превышении RPM > 1.5× лимита
- **Автоматическая разблокировка**: модели разблокируются через N секунд (N = 60 / rpm_limit)
- **Валидация ключей**: предупреждения при коротких или некорректных API ключах

### 3. Надежный цикл API-ключей

#### Улучшения:
- **Предотвращение дубликатов**: при сохранении ключа удаляются все существующие строки с этим env_var
- **Валидация ключей**: проверка длины и наличия пробелов
- **Предупреждения**: информирование пользователя о потенциально некорректных ключах

### 4. Автотесты

#### Реализованные тесты:
- `test_usage_tracker_provider_switching()` - переключение провайдеров
- `test_soft_blacklist()` - механизм мягкого черного списка
- `test_api_key_handling()` - обработка API ключей
- `test_state_persistence()` - сохранение состояния в файл
- `test_model_availability()` - доступность моделей

## Использование

### Запуск тестов

```bash
cd GopiAI-CrewAI
python run_model_tests.py
```

### Проверка REST API

```bash
# Получить текущее состояние
curl http://localhost:5051/internal/state

# Получить модели для провайдера
curl "http://localhost:5051/internal/models?provider=gemini"

# Обновить состояние
curl -X POST http://localhost:5051/internal/state \
  -H "Content-Type: application/json" \
  -d '{"provider": "openrouter", "model_id": "openrouter/mistralai-mistral-7b-instruct"}'
```

## Миграция

### С backend на fixed версию

1. Замените импорт:
   ```python
   # Было
   from llm_rotation_config import ...
   
   # Стало
   from llm_rotation_config_fixed import ...
   ```

2. Убедитесь, что все зависимости установлены:
   ```bash
   pip install requests
   ```

### Обновление виджета

1. Убедитесь, что в вашем окружении установлен `requests`
2. Виджет автоматически интегрируется с REST API backend

## Мониторинг

### Логирование

Система логирует важные события:
- Переключение провайдеров
- Блокировка/разблокировка моделей
- Ошибки валидации API ключей
- Проблемы синхронизации состояния

### Файлы состояния

- `~/.gopiai_state.json` - текущее состояние провайдера/модели
- `.env` - API ключи провайдеров

## Решение проблем

### Частые проблемы и их решения

1. **"Прыгающие" провайдеры**:
   - Убедитесь, что backend сервер запущен
   - Проверьте логи на наличие ошибок синхронизации

2. **Модель не отображается**:
   - Проверьте наличие API ключа в .env
   - Убедитесь, что ключ валиден
   - Проверьте логи backend на наличие ошибок

3. **Превышение лимитов**:
   - Проверьте статус модели через `is_model_blacklisted()`
   - Дождитесь автоматической разблокировки

### Отладка

```python
# Проверка состояния модели
from llm_rotation_config_fixed import is_model_blacklisted, get_model_usage_stats

model_id = "gemini/gemini-1.5-flash"
print(f"Заблокирована: {is_model_blacklisted(model_id)}")
print(f"Статистика: {get_model_usage_stats(model_id)}")
```

## Расширение функциональности

### Добавление нового провайдера

1. Добавьте запись в `PROVIDER_KEY_ENV`:
   ```python
   PROVIDER_KEY_ENV["новый_провайдер"] = "НОВЫЙ_ПРОВАЙДЕР_API_KEY"
   ```

2. Добавьте модели в `MODELS`:
   ```python
   {
       "display_name": "Название модели",
       "id": "новый_провайдер/идентификатор_модели",
       "provider": "новый_провайдер",
       "rpm": 10,
       "tpm": 1000000,
       "type": ["dialog", "code"],
       "priority": 3,
       "rpd": 100,
       "base_score": 0.5,
   }
   ```

3. Обновите виджет (автоматически поддержит новый провайдер)

## Тестирование

### Запуск тестов

```bash
cd GopiAI-CrewAI
python -m pytest test_model_switching.py -v
```

### Ручное тестирование

1. Запустите backend сервер
2. Откройте UI виджет
3. Переключите провайдер
4. Проверьте сохранение состояния
5. Проверьте обновление списка моделей

## Безопасность

### API ключи

- Ключи хранятся в `.env` файле
- Не передаются в логах или ошибках
- Валидируются при загрузке
- Предупреждают о потенциально некорректных значениях

### Состояние приложения

- Состояние сохраняется в `~/.gopiai_state.json`
- Файл защищен правами доступа пользователя
- Не содержит чувствительной информации
